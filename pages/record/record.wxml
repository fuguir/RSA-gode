<!-- pages/record/record.wxml -->
<view class="container">
  <!-- çŠ¶æ€æ  -->
  <view class="status-bar">
    <view class="status-group">
      <view class="status-item {{bleStatus ? 'active' : ''}}">
        <text>ğŸ“±</text>
        <text>è“ç‰™{{bleStatus ? 'å·²å¼€å¯' : 'æœªå¼€å¯'}}</text>
      </view>
      <view class="status-item {{connected ? 'active' : ''}}">
        <text>ğŸ“¹</text>
        <text>GoPro{{connected ? 'å·²è¿æ¥' : 'æœªè¿æ¥'}}</text>
      </view>
      <view class="status-item {{gpsStatus ? 'active' : ''}}">
        <text>ğŸ“</text>
        <text>GPS({{satellites}})</text>
      </view>
    </view>
  </view>

  <!-- ä¿¡æ¯æ˜¾ç¤ºåŒº -->
  <view class="info-section">
    <!-- æ¡©å·æ˜¾ç¤º -->
    <view class="stake-row">
      <view class="stake-panel">
        <view class="stake-value">K{{showStake}}</view>
        <view class="direction-indicator {{isIncreasing ? 'up' : 'down'}}">
          {{isIncreasing ? 'â†‘' : 'â†“'}}
        </view>
      </view>
      <button class="calibrate-btn" bindtap="onCalibrateStake">æ ¡å‡†æ¡©å·</button>
    </view>

    <!-- åœ°å›¾æ˜¾ç¤º -->
    <view class="map-panel">
      <map 
        wx:if="{{locationReady}}"
        id="trackMap"
        class="track-map"
        latitude="{{mapCenter.latitude}}"
        longitude="{{mapCenter.longitude}}"
        scale="{{mapScale}}"
        show-location
        show-compass
        enable-rotate
        enable-zoom
        polyline="{{trackPolylines}}"
        markers="{{mapMarkers}}">
        
        <!-- é€Ÿåº¦æ˜¾ç¤º -->
        <cover-view class="speed-panel">
          <cover-view class="speed-value">{{showSpeed}}</cover-view>
          <cover-view class="speed-unit">km/h</cover-view>
          <cover-view class="accuracy-text" wx:if="{{accuracy}}">
            ç²¾åº¦ Â±{{accuracy}}m
          </cover-view>
        </cover-view>
      </map>
      <view class="map-loading" wx:else>
        <text>GPSå®šä½ä¸­...</text>
      </view>
    </view>

    <!-- ç»Ÿè®¡é¢æ¿ -->
    <view class="stats-panel">
      <view class="stats-grid">
        <view class="stat-item">
          <text class="stat-value">{{showDuration}}</text>
          <text class="stat-label">å½•åˆ¶æ—¶é•¿</text>
        </view>
        <view class="stat-item">
          <text class="stat-value">{{currentChapter}}</text>
          <text class="stat-label">è§†é¢‘åˆ†æ®µ</text>
        </view>
        <view class="stat-item">
          <text class="stat-value">{{pointCount}}</text>
          <text class="stat-label">è½¨è¿¹ç‚¹æ•°</text>
        </view>
        <view class="stat-item">
          <text class="stat-value">{{totalDistance}}</text>
          <text class="stat-label">æ€»é‡Œç¨‹km</text>
        </view>
      </view>
    </view>
  </view>

  <!-- æ§åˆ¶é¢æ¿ -->
  <view class="control-panel">
    <block wx:if="{{!connected}}">
      <button 
        class="connect-btn {{!bleStatus ? 'disabled' : ''}}"
        bindtap="onConnect" 
        disabled="{{!bleStatus}}">
        è¿æ¥GoPro
      </button>
    </block>
    <block wx:else>
      <button 
        wx:if="{{!isRecording}}"
        class="direction-btn"
        bindtap="onToggleDirection">
        æ¡©å·{{isIncreasing ? 'é€’å¢' : 'é€’å‡'}}
      </button>
      <button 
        class="record-btn {{isRecording ? 'recording' : ''}} {{(!connected || !gpsStatus) ? 'disabled' : ''}}"
        bindtap="onRecordToggle"
        disabled="{{!connected || !gpsStatus}}">
        <view class="record-icon"></view>
        <text>{{isRecording ? 'åœæ­¢å½•åˆ¶' : 'å¼€å§‹å½•åˆ¶'}}</text>
      </button>
    </block>
  </view>
</view>

<!-- é”™è¯¯æç¤º -->
<view class="error-toast" wx:if="{{!bleStatus || !gpsStatus}}">
  <text>{{!bleStatus ? 'è¯·å¼€å¯è“ç‰™å¹¶å…è®¸ä½ç½®æƒé™' : 'è¯·å…è®¸ä½ç½®æƒé™ä»¥è·å–GPSä¿¡æ¯'}}</text>
</view>

<!-- åŠ è½½æç¤º -->
<view class="loading-mask" wx:if="{{isConnecting}}">
  <view class="loading-spinner"></view>
  <text>è¿æ¥ä¸­...</text>
</view>